# 🗺️ マップエディタ・経路探索アプリケーション

PySide6 (Qt6) ベースの室内マップエディタおよび経路探索システム

## 📋 プロジェクト概要

このアプリケーションは、複数階層の建物内マップを作成・編集し、経路探索（A*アルゴリズム）を実行できるツールです。
グリッドベースのマップエディタで、部屋・壁・ラベル・エレベーターなどを配置し、階をまたいだ経路探索が可能です。

## 🚀 起動方法

```bash
# 仮想環境をアクティベート
source env/bin/activate

# アプリケーション起動
python t10.py
```

## 📁 プロジェクト構造

### メインファイル

| ファイル | 行数 | 説明 |
|---------|------|------|
| `t10.py` | - | メインアプリケーション（起動エントリーポイント） |
| `map_widget.py` | 1,658 | マップウィジェットのコーディネーター |
| `config.py` | - | 設定定数・スタイル定義 |
| `dialogs.py` | - | ダイアログUI定義 |
| `auto_backup.py` | 548 | 自動バックアップ・復旧機能 |

### マップウィジェット管理モジュール（15個）

#### 🎨 描画・表示系

| モジュール | 行数 | 責務 |
|-----------|------|------|
| **map_renderer.py** | 914 | **レンダリングエンジン**<br>・グリッド、セル、部屋、ラベル、壁線の描画<br>・背景画像の合成<br>・レイヤー別の描画制御 |
| **map_effects.py** | 475 | **視覚エフェクト**<br>・ハイライト表示（ホバー、選択）<br>・アニメーション効果<br>・検索結果の強調表示 |
| **map_background.py** | 318 | **背景画像管理**<br>・画像の読み込み・保存<br>・拡大縮小・回転・移動<br>・透明度制御 |

#### 🖱️ 入力・操作系

| モジュール | 行数 | 責務 |
|-----------|------|------|
| **map_input_handler.py** | 479 | **入力イベント処理**<br>・マウスイベント（クリック、ドラッグ、ホバー）<br>・キーボードイベント<br>・ホイールズーム |
| **map_zoom_manager.py** | 254 | **ズーム制御**<br>・ズームレベル管理<br>・スライダー連携<br>・表示スケール計算 |
| **map_layer_manager.py** | 273 | **レイヤー管理**<br>・レイヤー表示/非表示切り替え<br>・レイヤー種別（床、壁、ラベル等） |

#### 💾 データ・状態管理系

| モジュール | 行数 | 責務 |
|-----------|------|------|
| **map_data_manager.py** | 897 | **データ永続化**<br>・ファイル保存/読み込み（JSON）<br>・マルチフロア管理<br>・データシリアライズ/デシリアライズ |
| **map_history.py** | 209 | **履歴管理**<br>・Undo/Redo機能<br>・編集履歴スタック管理<br>・状態スナップショット |

#### 🏠 マップ要素管理系

| モジュール | 行数 | 責務 |
|-----------|------|------|
| **map_room_manager.py** | 643 | **部屋管理**<br>・部屋の作成・編集・削除<br>・部屋名の管理<br>・部屋の矩形範囲管理 |
| **map_label_manager.py** | 333 | **ラベル管理**<br>・ラベルのフィルタリング<br>・ラベルグループ化<br>・ラベル選択・配置 |
| **map_wall_lines.py** | 316 | **壁線描画**<br>・直線描画（Bresenhamアルゴリズム）<br>・グリッドスナッピング<br>・壁線の交差判定 |
| **map_drawing_tools.py** | 296 | **描画ツール**<br>・直線描画ツール<br>・塗りつぶしツール（Flood Fill）<br>・矩形描画ツール |

#### 🔗 階層間連携系

| モジュール | 行数 | 責務 |
|-----------|------|------|
| **map_elevator_manager.py** | 306 | **エレベーター管理**<br>・エレベーター配置・削除<br>・エレベーターダイアログUI<br>・フロアリスト管理 |
| **map_cross_floor_links.py** | 414 | **フロア間リンク**<br>・階段・エレベーターリンク管理<br>・プレビューフロア表示<br>・クロスフロア接続データ |

#### 🧭 経路探索系

| モジュール | 行数 | 責務 |
|-----------|------|------|
| **map_pathfinding.py** | 769 | **経路探索アルゴリズム**<br>・A*経路探索実装<br>・複数フロア対応経路計算<br>・ヒューリスティック関数<br>・経路表示・ハイライト |

## 🏗️ アーキテクチャ

### 設計パターン: **委譲パターン (Delegation Pattern)**

`MapWidget` クラスがコーディネーターとして機能し、各専門マネージャーに処理を委譲します。

```python
# MapWidget (コーディネーター)
class MapWidget(QWidget):
    def __init__(self):
        # マネージャーの初期化
        self.renderer = MapRenderer(self)
        self.input_handler = MapInputHandler(self)
        self.data_manager = MapDataManager(self)
        self.history = MapHistory(self)
        self.pathfinding = MapPathfinding(self)
        # ... 他のマネージャー
    
    # 委譲メソッドの例
    def save_map(self, filename):
        return self.data_manager.save_map(filename)
    
    def find_path(self, start, goal):
        return self.pathfinding.find_path(start, goal)
```

### モジュール間の関係

```
┌─────────────────────────────────────────┐
│         t10.py (Main Window)           │
└──────────────────┬──────────────────────┘
                   │
          ┌────────▼─────────┐
          │   map_widget.py  │ ◄── コーディネーター
          │   (1,658 lines)  │
          └────────┬─────────┘
                   │
        ┌──────────┴────────────────┐
        │                           │
        ▼                           ▼
┌───────────────┐          ┌──────────────────┐
│  描画・表示   │          │  データ・状態    │
├───────────────┤          ├──────────────────┤
│ renderer      │          │ data_manager     │
│ effects       │          │ history          │
│ background    │          │                  │
└───────────────┘          └──────────────────┘
        │                           │
        ▼                           ▼
┌───────────────┐          ┌──────────────────┐
│  入力・操作   │          │  マップ要素      │
├───────────────┤          ├──────────────────┤
│ input_handler │          │ room_manager     │
│ zoom_manager  │          │ label_manager    │
│ layer_manager │          │ wall_lines       │
└───────────────┘          │ drawing_tools    │
                           └──────────────────┘
                                    │
                                    ▼
                           ┌──────────────────┐
                           │  階層間連携      │
                           ├──────────────────┤
                           │ elevator_manager │
                           │ cross_floor_links│
                           │ pathfinding      │
                           └──────────────────┘
```

## 💾 データ管理

### バックアップシステム

- **自動バックアップ**: 定期的に `backups/` ディレクトリに保存
- **復旧機能**: クラッシュ時の自動復旧
- **バックアップ形式**: `map_YYYYMMDD_HHMMSS.json`

```
backups/
├── map_20251104_001712.json  # 自動バックアップ
├── recovery/                 # 復旧用
└── map_YYYYMMDD_HHMMSS_assets/  # 画像付きバックアップ
```

### データ形式

マップデータはJSON形式で保存され、以下の情報を含みます：

- グリッドデータ（各セルの状態）
- 部屋情報（名前、範囲）
- ラベル情報（位置、種別）
- 壁線データ
- エレベーター・階段の接続情報
- 背景画像データ（Base64エンコード）

## 🔧 主要機能

### ✏️ 編集機能
- グリッドセルの編集（床、壁、通路など）
- 部屋の作成・名前付け
- ラベル配置（複数種類）
- 壁線の描画
- 背景画像の配置・調整

### 🗺️ マルチフロア機能
- 複数階層の管理
- フロア間の切り替え
- エレベーター・階段による接続
- クロスフロアプレビュー

### 🧭 経路探索
- A*アルゴリズムによる最短経路探索
- 複数フロアをまたぐ経路計算
- 経路のビジュアル表示

### 🔄 編集サポート
- Undo/Redo機能
- 自動バックアップ
- クラッシュ復旧

### 🎨 描画ツール
- 直線描画
- 塗りつぶし
- 矩形描画
- ズーム・パン

## 📊 リファクタリング履歴

### Before (2024年10月)
- `map_widget.py`: **6,383行** (単一の巨大ファイル)

### After (2024年11月)
- `map_widget.py`: **1,658行** (コーディネーターのみ)
- **15個の専門モジュール**: 合計 **6,896行**
- **削減率**: **74%** 🎉

### リファクタリングの効果
- ✅ 各モジュールの責務が明確化
- ✅ コードの可読性・保守性が向上
- ✅ テストがしやすくなった
- ✅ 機能追加が容易になった

## 🛠️ 技術スタック

- **GUI Framework**: PySide6 (Qt6)
- **言語**: Python 3.x
- **アルゴリズム**: A*経路探索、Bresenham直線描画、Flood Fill
- **データ形式**: JSON
- **画像処理**: PIL/Pillow, NumPy

## 📝 開発ガイドライン

### 新機能の追加方法

1. **適切なマネージャーを特定**: 機能の責務に応じてモジュールを選択
2. **マネージャーにメソッド追加**: 該当モジュール内に実装
3. **MapWidgetに委譲メソッド追加**: 必要に応じてラッパーメソッドを作成
4. **履歴対応**: 状態変更を伴う場合は `history.save_state()` を呼び出し

### コーディング規約

- **委譲パターンの維持**: MapWidgetから直接処理せず、適切なマネージャーに委譲
- **単一責任の原則**: 各マネージャーは1つの明確な責務を持つ
- **エラーハンドリング**: try-except でエラーを適切に処理
- **状態管理**: 編集操作は履歴に記録

## 📂 その他のディレクトリ

- `bu/`: 開発中のバックアップ・実験用コード
- `env/`: Python仮想環境
- `map/`: マップデータ（オプション）
- `__pycache__/`: Pythonキャッシュ

## 🎯 今後の改善案

- [ ] 型ヒント (Type Hints) の追加
- [ ] Docstring の充実
- [ ] ユニットテストの作成
- [ ] パフォーマンス最適化
- [ ] UI/UX の改善
- [ ] エクスポート機能（PNG、PDF等）

## 📄 ライセンス

（プロジェクトのライセンスを記載）

## 👤 作成者

田中英二

---

**最終更新**: 2025年11月4日
**バージョン**: リファクタリング完了版 (v2.0)
